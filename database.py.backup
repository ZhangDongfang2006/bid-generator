"""
å…¬å¸èµ„æ–™æ•°æ®åº“ç®¡ç†æ¨¡å—

æ•°æ®ä¿æŠ¤æœºåˆ¶ï¼š
- é»˜è®¤ä½¿ç”¨ç¤ºä¾‹æ•°æ®ï¼ˆç”¨äºå¼€æºæ¼”ç¤ºï¼‰
- åªæœ‰åœ¨è®¾ç½®ç¯å¢ƒå˜é‡åæ‰åŠ è½½çœŸå®æ•°æ®
- çœŸå®æ•°æ®ç›®å½•å·²è¢« .gitignore å¿½ç•¥
"""

import json
import os
from pathlib import Path
from typing import Dict, List, Optional, Any
from datetime import datetime


class CompanyDatabase:
    """å…¬å¸èµ„æ–™æ•°æ®åº“"""

    def __init__(self, data_dir: Path):
        # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ç¤ºä¾‹æ•°æ®
        self.use_demo_data = os.getenv("USE_DEMO_DATA", "true").lower() == "true"
        self.data_dir = data_dir
        self.examples_dir = data_dir.parent / "data" / "examples"

        # æ ¹æ®æ¨¡å¼é€‰æ‹©æ•°æ®ç›®å½•
        if self.use_demo_data:
            self.base_dir = self.examples_dir
            print("=" * 50)
            print("ğŸ“Š æ•°æ®æ¨¡å¼ï¼šç¤ºä¾‹æ•°æ®ï¼ˆDEMOï¼‰")
            print("=" * 50)
            print("âœ“ å½“å‰ä½¿ç”¨ç¤ºä¾‹æ•°æ®è¿›è¡Œæ¼”ç¤º")
            print("âœ“ ä¸ä¼šåŠ è½½çœŸå®å…¬å¸æ•°æ®")
            print("")
            print("ğŸ’¡ å¦‚éœ€ä½¿ç”¨çœŸå®æ•°æ®ï¼Œè¯·è®¾ç½®ç¯å¢ƒå˜é‡ï¼š")
            print("   export USE_DEMO_DATA=false")
            print("   æˆ–åœ¨ .env æ–‡ä»¶ä¸­æ·»åŠ ï¼šUSE_DEMO_DATA=false")
            print("=" * 50)
        else:
            self.base_dir = data_dir
            print("=" * 50)
            print("ğŸ“Š æ•°æ®æ¨¡å¼ï¼šçœŸå®æ•°æ®ï¼ˆPRODUCTIONï¼‰")
            print("=" * 50)
            print("âœ“ æ­£åœ¨åŠ è½½çœŸå®å…¬å¸æ•°æ®")
            print("âœ“ èµ„è´¨ã€æ¡ˆä¾‹ã€äº§å“ã€äººå‘˜ä¿¡æ¯å°†å…¨éƒ¨åŠ è½½")
            print("=" * 50)

        # è®¾ç½®æ•°æ®æ–‡ä»¶è·¯å¾„
        self.qualification_file = self.base_dir / "qualifications.json"
        self.cases_file = self.base_dir / "cases.json"
        self.products_file = self.base_dir / "products.json"
        self.personnel_file = self.base_dir / "personnel.json"

        # åˆå§‹åŒ–æ•°æ®æ–‡ä»¶
        self._init_data_files()

    def _init_data_files(self):
        """åˆå§‹åŒ–æ•°æ®æ–‡ä»¶"""
        if not self.qualification_file.exists():
            self._save_json(self.qualification_file, {
                "qualifications": [],
                "certificates": [],
                "honors": []
            })

        if not self.cases_file.exists():
            self._save_json(self.cases_file, {
                "cases": []
            })

        if not self.products_file.exists():
            self._save_json(self.products_file, {
                "products": [],
                "prices": {}
            })

        if not self.personnel_file.exists():
            self._save_json(self.personnel_file, {
                "management": [],
                "engineers": [],
                "workers": []
            })

    def _load_json(self, filepath: Path) -> Dict:
        """åŠ è½½JSONæ–‡ä»¶"""
        try:
            with open(filepath, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            print(f"Error loading {filepath}: {e}")
            return {}

    def _save_json(self, filepath: Path, data: Dict):
        """ä¿å­˜JSONæ–‡ä»¶"""
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)

    # ==================== èµ„è´¨ç®¡ç† ====================

    def get_qualifications(self) -> List[Dict]:
        """è·å–æ‰€æœ‰èµ„è´¨"""
        data = self._load_json(self.qualification_file)
        return data.get("qualifications", [])

    def add_qualification(self, name: str, level: str, cert_no: str,
                          valid_until: str, cert_file: str = ""):
        """æ·»åŠ èµ„è´¨"""
        data = self._load_json(self.qualification_file)
        data["qualifications"].append({
            "id": len(data["qualifications"]) + 1,
            "name": name,
            "level": level,
            "cert_no": cert_no,
            "valid_until": valid_until,
            "cert_file": cert_file,
            "created_at": datetime.now().isoformat()
        })
        self._save_json(self.qualification_file, data)

    def get_valid_qualifications(self) -> List[Dict]:
        """è·å–æœ‰æ•ˆèµ„è´¨"""
        today = datetime.now().strftime("%Y-%m-%d")
        qualifications = self.get_qualifications()
        valid = []

        for q in qualifications:
            valid_until = q.get("valid_until", "").strip()
            # å¦‚æœæœ‰æ•ˆæœŸæ˜¯ç©ºçš„ï¼Œè®¤ä¸ºæ°¸ä¹…æœ‰æ•ˆ
            if not valid_until:
                valid.append(q)
            # å¦åˆ™æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            elif valid_until >= today:
                valid.append(q)

        return valid

    # ==================== æ¡ˆä¾‹ç®¡ç† ====================

    def get_cases(self, industry: str = None) -> List[Dict]:
        """è·å–æ¡ˆä¾‹"""
        data = self._load_json(self.cases_file)
        cases = data.get("cases", [])

        if industry:
            return [c for c in cases if industry.lower() in c.get("industry", "").lower()]
        return cases

    def add_case(self, project_name: str, client: str, industry: str,
                 product_type: str, amount: float, year: int,
                 description: str = ""):
        """æ·»åŠ æ¡ˆä¾‹"""
        data = self._load_json(self.cases_file)
        data["cases"].append({
            "id": len(data["cases"]) + 1,
            "project_name": project_name,
            "client": client,
            "industry": industry,
            "product_type": product_type,
            "amount": amount,
            "year": year,
            "description": description,
            "created_at": datetime.now().isoformat()
        })
        self._save_json(self.cases_file, data)

    # ==================== äº§å“ç®¡ç† ====================

    def get_products(self, category: str = None) -> List[Dict]:
        """è·å–äº§å“"""
        data = self._load_json(self.products_file)
        products = data.get("products", [])

        if category:
            return [p for p in products if category.lower() in p.get("category", "").lower()]
        return products

    def add_product(self, name: str, model: str, category: str,
                    description: str = "", base_price: float = 0):
        """æ·»åŠ äº§å“"""
        data = self._load_json(self.products_file)
        data["products"].append({
            "id": len(data["products"]) + 1,
            "name": name,
            "model": model,
            "category": category,
            "description": description,
            "base_price": base_price,
            "created_at": datetime.now().isoformat()
        })
        self._save_json(self.products_file, data)

    def get_product_by_model(self, model: str) -> Optional[Dict]:
        """æ ¹æ®å‹å·è·å–äº§å“"""
        products = self.get_products()
        for p in products:
            if p["model"].lower() == model.lower():
                return p
        return None

    # ==================== äººå‘˜ç®¡ç† ====================

    def get_personnel(self, role: str = None) -> List[Dict]:
        """è·å–äººå‘˜"""
        data = self._load_json(self.personnel_file)
        all_personnel = []

        for key in ["management", "engineers", "workers"]:
            all_personnel.extend(data.get(key, []))

        if role:
            return [p for p in all_personnel if role.lower() in p.get("role", "").lower()]
        return all_personnel

    def add_personnel(self, name: str, role: str, title: str,
                      experience: int, certificates: List[str] = None):
        """æ·»åŠ äººå‘˜"""
        data = self._load_json(self.personnel_file)

        # æ ¹æ®èŒä½åˆ†ç±»
        if "ç»ç†" in role or "æ€»ç›‘" in role or "æ€»ç»ç†" in role:
            category = "management"
        elif "å·¥ç¨‹å¸ˆ" in role or "æŠ€æœ¯" in role:
            category = "engineers"
        else:
            category = "workers"

        data[category].append({
            "id": len(data.get(category, [])) + 1,
            "name": name,
            "role": role,
            "title": title,
            "experience": experience,
            "certificates": certificates or [],
            "created_at": datetime.now().isoformat()
        })
        self._save_json(self.personnel_file, data)

    # ==================== æ™ºèƒ½åŒ¹é… ====================

    def match_qualifications(self, requirements: List[str]) -> List[Dict]:
        """æ™ºèƒ½åŒ¹é…èµ„è´¨"""
        qualifications = self.get_qualifications()  # æ”¹ä¸ºè·å–æ‰€æœ‰èµ„è´¨ï¼Œä¸å†è¿‡æ»¤
        matched = []
        matched_ids = set()

        for req in requirements:
            req_lower = req.lower()

            for q in qualifications:
                if q["id"] in matched_ids:
                    continue

                q_name_lower = q["name"].lower()
                q_level_lower = q["level"].lower()

                # å°è¯•å¤šç§åŒ¹é…æ–¹å¼
                if (req_lower in q_name_lower or
                    req_lower in q_level_lower or
                    q_name_lower in req_lower or
                    q_level_lower in req_lower):

                    matched.append(q)
                    matched_ids.add(q["id"])
                    break

        # å¦‚æœåŒ¹é…åˆ°çš„è¯ä¹¦å°‘äº10ä¸ªï¼Œè¿”å›æ‰€æœ‰æœ‰PDFçš„è¯ä¹¦çš„å‰20ä¸ª
        if len(matched) < 10 and qualifications:
            # ç­›é€‰å‡ºæœ‰PDFçš„è¯ä¹¦
            with_pdf = [q for q in qualifications if q.get('cert_file')]
            matched = with_pdf[:20]

        return matched

    def match_cases(self, industry: str, product_type: str = None,
                    min_amount: float = 0, limit: int = 5) -> List[Dict]:
        """æ™ºèƒ½åŒ¹é…æ¡ˆä¾‹"""
        # è·å–æ‰€æœ‰æ¡ˆä¾‹ï¼ˆä¸å†æŒ‰è¡Œä¸šè¿‡æ»¤ï¼‰
        cases = self.get_cases()

        # å¦‚æœæ²¡æœ‰product_typeï¼Œè¿”å›æœ€æ–°çš„æ¡ˆä¾‹
        if not product_type:
            cases.sort(key=lambda x: x.get("year", 0), reverse=True)
            return cases[:limit]

        # æŒ‰äº§å“ç±»å‹æ™ºèƒ½åŒ¹é…
        product_type_lower = product_type.lower()
        matched_cases = []

        for c in cases:
            c_product_type = c.get("product_type", "").lower()
            c_name = c.get("project_name", "").lower()

            # æ£€æŸ¥äº§å“ç±»å‹æ˜¯å¦åŒ¹é…ï¼ˆå¤šç§æ–¹å¼ï¼‰
            if (product_type_lower in c_product_type or
                c_product_type in product_type_lower or
                product_type_lower in c_name):

                matched_cases.append(c)

        # å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å›æœ€æ–°çš„æ¡ˆä¾‹
        if not matched_cases:
            cases.sort(key=lambda x: x.get("year", 0), reverse=True)
            return cases[:limit]

        # æŒ‰é‡‘é¢è¿‡æ»¤
        if min_amount > 0:
            matched_cases = [c for c in matched_cases if c.get("amount", 0) >= min_amount]

        # æŒ‰å¹´ä»½æ’åºï¼ˆæœ€æ–°çš„ä¼˜å…ˆï¼‰
        matched_cases.sort(key=lambda x: x.get("year", 0), reverse=True)

        return matched_cases[:limit]

    def match_products(self, keywords: List[str]) -> List[Dict]:
        """æ™ºèƒ½åŒ¹é…äº§å“"""
        products = self.get_products()
        matched = []

        if not keywords:
            return products[:10]  # å¦‚æœæ²¡æœ‰å…³é”®è¯ï¼Œè¿”å›å‰10ä¸ªäº§å“

        for p in products:
            p_name_lower = p["name"].lower()
            p_model_lower = p["model"].lower()
            p_category_lower = p.get("category", "").lower()

            # æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•ä¸€ä¸ªå…³é”®è¯
            for kw in keywords:
                kw_lower = kw.lower()

                if (kw_lower in p_name_lower or
                    kw_lower in p_model_lower or
                    kw_lower in p_category_lower or
                    p_name_lower in kw_lower or
                    p_model_lower in kw_lower):

                    matched.append(p)
                    break

        # å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å›æ‰€æœ‰äº§å“
        if not matched and products:
            matched = products

        return matched


# åˆå§‹åŒ–æ•°æ®åº“ï¼ˆç”¨äºæµ‹è¯•ï¼‰
if __name__ == "__main__":
    data_dir = Path(__file__).parent / "data"
    db = CompanyDatabase(data_dir)

    # æ·»åŠ æµ‹è¯•æ•°æ®
    print("åˆå§‹åŒ–æ•°æ®åº“...")

    # æ·»åŠ èµ„è´¨
    db.add_qualification(
        name="ç”µåŠ›å·¥ç¨‹æ–½å·¥æ€»æ‰¿åŒ…",
        level="ä¸‰çº§",
        cert_no="D242010979",
        valid_until="2028-12-31"
    )

    db.add_qualification(
        name="æ‰¿è£…ï¼ˆä¿®ã€è¯•ï¼‰ç”µåŠ›è®¾æ–½è®¸å¯è¯",
        level="å››çº§",
        cert_no="6-1-00357-2018",
        valid_until="2027-06-30"
    )

    # æ·»åŠ æ¡ˆä¾‹
    db.add_case(
        project_name="ä¸­å¤©é’¢é“é›†å›¢ï¼ˆæ·®å®‰ï¼‰æ–°ææ–™æœ‰é™å…¬å¸10kVä¸­å‹æŸœ",
        client="ä¸­å¤©é’¢é“é›†å›¢",
        industry="é’¢é“",
        product_type="é«˜å‹å¼€å…³æŸœ",
        amount=550000,
        year=2025,
        description="ä¸‰å‚10kVä¸­å‹æŸœé‡‡è´­é¡¹ç›®"
    )

    db.add_case(
        project_name="æ±‰è¥¿æ±¡æ°´å¤„ç†å‚ä¸‰æœŸå·¥ç¨‹ä½å‹å¼€å…³æŸœ",
        client="è‘›æ´²åé›†å›¢",
        industry="ç¯ä¿",
        product_type="ä½å‹å¼€å…³æŸœ",
        amount=2800000,
        year=2025,
        description="ä½å‹å¼€å…³æŸœã€åŠ¨åŠ›é…ç”µç®±ç­‰é‡‡è´­"
    )

    # æ·»åŠ äº§å“
    db.add_product(
        name="æˆ·å†…äº¤æµé‡‘å±é“ è£…ç§»å¼€å¼å¼€å…³è®¾å¤‡",
        model="KYN28A-12",
        category="é«˜å‹å¼€å…³æŸœ",
        description="é€‚ç”¨äºé¢å®šç”µå‹3.6-12kVä¸‰ç›¸äº¤æµ50Hzç”µåŠ›ç³»ç»Ÿä¸­",
        base_price=50000
    )

    db.add_product(
        name="ä½å‹æŠ½å‡ºå¼å¼€å…³æŸœ",
        model="MNS",
        category="ä½å‹å¼€å…³æŸœ",
        description="é€‚ç”¨äºå‘ç”µå‚ã€å˜ç”µç«™ã€çŸ³æ²¹åŒ–å·¥ç­‰åœºæ‰€",
        base_price=30000
    )

    db.add_product(
        name="ç®±å¼å˜ç”µç«™",
        model="ZGS11",
        category="é¢„åˆ¶èˆ±",
        description="ä¸€ä½“åŒ–é¢„è£…å¼å˜ç”µç«™",
        base_price=80000
    )

    # æ·»åŠ äººå‘˜
    db.add_personnel(
        name="å¼ ä¸‰",
        role="æŠ€æœ¯æ€»ç›‘",
        title="é«˜çº§å·¥ç¨‹å¸ˆ",
        experience=20,
        certificates=["æ³¨å†Œç”µæ°”å·¥ç¨‹å¸ˆ", "é«˜çº§å·¥ç¨‹å¸ˆ"]
    )

    db.add_personnel(
        name="æå››",
        role="é¡¹ç›®ç»ç†",
        title="å·¥ç¨‹å¸ˆ",
        experience=10,
        certificates=["ä¸€çº§å»ºé€ å¸ˆ", "PMP"]
    )

    print("æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼")
    print(f"èµ„è´¨: {len(db.get_qualifications())}")
    print(f"æ¡ˆä¾‹: {len(db.get_cases())}")
    print(f"äº§å“: {len(db.get_products())}")
    print(f"äººå‘˜: {len(db.get_personnel())}")
